<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>thuÃª SMS OKVIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 820px;
  margin: auto;
  position: relative;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button {
  cursor: pointer;
}
.sim {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
.sim b {
  font-size: 16px;
}
pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow: auto;
}
.lock {
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.proxy-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: auto;
  padding: 8px 14px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
}
.proxy-btn:hover {
  background: #0056b3;
}
</style>
</head>

<body>
<div class="box">

<button class="proxy-btn" onclick="window.location.href='index.html'">ğŸŒ PROXY</button>

<h2>ğŸ“² ThuÃª SMS OKVIP</h2>

<input id="apiKey" placeholder="Nháº­p API key">

<button onclick="loadAccount()">ğŸ”‘ Láº¥y thÃ´ng tin tÃ i khoáº£n</button>

<div class="lock">
  ğŸ”’ <b>ThuÃª sms:</b> Okvip â€“ <b>5K</b>
</div>

<select id="network">
  <option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>
</select>

<input id="prefix" placeholder="Äáº§u sá»‘ (vd: 098 - khÃ´ng báº¯t buá»™c)">

<button onclick="getSim()">ğŸ“ Láº¥y sá»‘</button>

<h3>ğŸ“‹ Danh sÃ¡ch SIM (tá»‘i Ä‘a 2 sim chá»)</h3>
<div id="simList"></div>

<pre id="log">Sáºµn sÃ ng</pre>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER = "https://api.dblgamingg.workers.dev";
const FIXED_SERVICE_ID = 49;

/* ================= STORAGE KEYS ================= */
const SIM_KEY = "okvip_sims";
const API_KEY_STORE = "okvip_api_key";

/* ================= STATE ================= */
let sims = [];
let otpTimer = null;

/* ================= API KEY FIX ================= */
const apiKeyInput = () => document.getElementById("apiKey");

function getApiKey() {
  return apiKeyInput().value.trim();
}

function saveApiKey() {
  localStorage.setItem(API_KEY_STORE, getApiKey());
}

/* ================= STORAGE SIM ================= */
function saveSims() {
  localStorage.setItem(SIM_KEY, JSON.stringify(sims));
}

function loadSims() {
  const raw = localStorage.getItem(SIM_KEY);
  if (!raw) return;
  try {
    sims = JSON.parse(raw);
    if (sims.length) {
      renderSims();
      startOtp();
    }
  } catch {}
}

/* ================= UTILS ================= */
const log = (t) => document.getElementById("log").textContent = t;

async function call(path) {
  const res = await fetch(WORKER + path);
  return res.json();
}

/* ================= 1. ACCOUNT ================= */
async function loadAccount() {
  if (!getApiKey()) return alert("Nháº­p API key");
  saveApiKey();

  const d = await call(`/account?api_key=${getApiKey()}`);
  if (!d || d.status !== 200) return log("âŒ Lá»—i API");

  log(JSON.stringify(d, null, 2));
  loadNetworks();
}

/* ================= 2. NETWORKS ================= */
async function loadNetworks() {
  const d = await call(`/networks?api_key=${getApiKey()}`);
  if (!d || d.status !== 200) return;

  const n = document.getElementById("network");
  n.innerHTML = '<option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>';
  d.data.forEach(x => {
    n.innerHTML += `<option value="${x.id}">${x.name}</option>`;
  });
}

/* ================= 3. GET SIM ================= */
async function getSim() {
  if (!getApiKey()) return alert("Thiáº¿u API key");
  saveApiKey();

  const network = document.getElementById("network").value;
  const prefix = document.getElementById("prefix").value;

  let q = `/get-sim?api_key=${getApiKey()}&service_id=${FIXED_SERVICE_ID}`;
  if (network) q += `&network_id=${network}`;
  if (prefix) q += `&phone=${prefix}`;

  const d = await call(q);
  if (!d || d.status !== 200) return log("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c sá»‘");

  sims.push({
    otpId: d.data.otpId,
    simId: d.data.simId,
    phone: d.data.phone,
    code: null
  });

  saveSims();
  renderSims();
  startOtp();
}

/* ================= 4. RENDER ================= */
function renderSims() {
  const box = document.getElementById("simList");
  box.innerHTML = "";

  sims.forEach((s, i) => {
    box.innerHTML += `
      <div class="sim">
        <b>ğŸ“ ${s.phone}</b><br>
        ğŸ†” OTP ID: ${s.otpId}<br>
        ğŸ” OTP: ${s.code ?? "Äang chá»..."}<br>
        <button onclick="cancelSim(${i})">âŒ Há»§y SIM</button>
      </div>
    `;
  });
}

/* ================= 5. OTP POLL ================= */
function startOtp() {
  if (otpTimer) return;

  otpTimer = setInterval(async () => {
    for (const s of sims) {
      if (s.code) continue;

      const d = await call(`/get-otp?api_key=${getApiKey()}&otp_id=${s.otpId}`);
      if (d?.data?.code) {
        s.code = d.data.code;
        saveSims();
      }
    }
    renderSims();
  }, 4000);
}

/* ================= 6. CANCEL ================= */
async function cancelSim(index) {
  const s = sims[index];
  await call(`/cancel?api_key=${getApiKey()}&sim_id=${s.simId}`);

  sims.splice(index, 1);
  saveSims();
  renderSims();

  if (!sims.length) {
    clearInterval(otpTimer);
    otpTimer = null;
    localStorage.removeItem(SIM_KEY);
  }
}

/* ================= INIT ================= */
window.onload = () => {
  // load api key
  const savedKey = localStorage.getItem(API_KEY_STORE);
  if (savedKey) apiKeyInput().value = savedKey;

  loadSims();
};
</script>
</body>
</html>

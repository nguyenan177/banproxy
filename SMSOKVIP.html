<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>thuÃª SMS OKVIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 820px;
  margin: auto;
  position: relative;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button { cursor: pointer; }

.sim {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
.sim b { font-size: 16px; }

.inline {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 4px 0;
}

/* COPY ICON */
.copy-icon {
  width: 26px;
  height: 26px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #e9ecef;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}
.copy-icon:hover {
  background: #007bff;
  color: #fff;
}
.copy-icon.done {
  background: #28a745;
  color: #fff;
}

pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow: auto;
}
.lock {
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.proxy-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: auto;
  padding: 8px 14px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
}
</style>
</head>

<body>
<div class="box">

<button class="proxy-btn" onclick="window.location.href='index.html'">ğŸŒ PROXY</button>

<h2>ğŸ“² ThuÃª SMS OKVIP</h2>

<input id="apiKey" placeholder="Nháº­p API key">
<button onclick="loadAccount()">ğŸ”‘ Láº¥y thÃ´ng tin tÃ i khoáº£n</button>

<div class="lock">
  ğŸ”’ <b>ThuÃª sms:</b> Okvip â€“ <b>5K</b>
</div>

<select id="network">
  <option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>
</select>

<input id="prefix" placeholder="Äáº§u sá»‘ (vd: 098 - khÃ´ng báº¯t buá»™c)">
<button onclick="getSim()">ğŸ“ Láº¥y sá»‘</button>

<h3>ğŸ“‹ Danh sÃ¡ch SIM (tá»‘i Ä‘a 2 sim chá»)</h3>
<div id="simList"></div>

<pre id="log">Sáºµn sÃ ng</pre>
</div>

<script>
const WORKER = "https://api.dblgamingg.workers.dev";
const FIXED_SERVICE_ID = 49;
const SIM_KEY = "okvip_sims";
const API_KEY_STORE = "okvip_api_key";

let sims = [];
let otpTimer = null;

const apiKeyInput = () => document.getElementById("apiKey");
const getApiKey = () => apiKeyInput().value.trim();
const saveApiKey = () => localStorage.setItem(API_KEY_STORE, getApiKey());
const log = (t) => document.getElementById("log").textContent = t;

async function call(path) {
  const r = await fetch(WORKER + path);
  return r.json();
}

/* COPY WITH CHECK */
function copyWithCheck(el, text, msg) {
  navigator.clipboard.writeText(text);
  const old = el.textContent;
  el.textContent = "âœ…";
  el.classList.add("done");
  log(msg);

  setTimeout(() => {
    el.textContent = old;
    el.classList.remove("done");
  }, 1500);
}

function copyPhone(el, phone) {
  const p = phone.startsWith("0") ? phone.slice(1) : phone;
  copyWithCheck(el, p, "ğŸ“‹ ÄÃ£ copy SÄT: " + p);
}

function copyOtp(el, code) {
  if (!code) return;
  copyWithCheck(el, code, "ğŸ“‹ ÄÃ£ copy OTP: " + code);
}

/* ACCOUNT */
async function loadAccount() {
  if (!getApiKey()) return alert("Nháº­p API key");
  saveApiKey();
  const d = await call(`/account?api_key=${getApiKey()}`);
  if (d?.data?.balance) d.data.balance /= 0.4;
  log(JSON.stringify(d, null, 2));
  loadNetworks();
}

async function loadNetworks() {
  const d = await call(`/networks?api_key=${getApiKey()}`);
  const n = document.getElementById("network");
  n.innerHTML = '<option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>';
  d.data?.forEach(x => n.innerHTML += `<option value="${x.id}">${x.name}</option>`);
}

/* GET SIM */
async function getSim() {
  let q = `/get-sim?api_key=${getApiKey()}&service_id=${FIXED_SERVICE_ID}`;
  if (network.value) q += `&network_id=${network.value}`;
  if (prefix.value) q += `&phone=${prefix.value}`;

  const d = await call(q);
  if (!d?.data) return log("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c sá»‘");

  sims.push({
    otpId: d.data.otpId,
    simId: d.data.simId,
    phone: d.data.phone,
    code: null
  });

  localStorage.setItem(SIM_KEY, JSON.stringify(sims));
  renderSims();
  startOtp();
}

/* RENDER */
function renderSims() {
  const box = document.getElementById("simList");
  box.innerHTML = "";

  sims.forEach((s, i) => {
    box.innerHTML += `
      <div class="sim">
        <div class="inline">
          <b>ğŸ“ ${s.phone}</b>
          <span class="copy-icon"
            onclick="copyPhone(this,'${s.phone}')">ğŸ“‹</span>
        </div>

        <div class="inline">
          ğŸ” OTP: ${s.code ?? "Äang chá»..."}
          ${s.code ? `
          <span class="copy-icon"
            onclick="copyOtp(this,'${s.code}')">ğŸ“‹</span>` : ""}
        </div>

        ğŸ†” OTP ID: ${s.otpId}<br><br>
        <button onclick="cancelSim(${i})">âŒ Há»§y SIM</button>
      </div>
    `;
  });
}

/* OTP */
function startOtp() {
  if (otpTimer) return;
  otpTimer = setInterval(async () => {
    for (const s of sims) {
      if (s.code) continue;
      const d = await call(`/get-otp?api_key=${getApiKey()}&otp_id=${s.otpId}`);
      if (d?.data?.code) s.code = d.data.code;
    }
    localStorage.setItem(SIM_KEY, JSON.stringify(sims));
    renderSims();
  }, 4000);
}

async function cancelSim(i) {
  await call(`/cancel?api_key=${getApiKey()}&sim_id=${sims[i].simId}`);
  sims.splice(i, 1);
  localStorage.setItem(SIM_KEY, JSON.stringify(sims));
  renderSims();
}

/* INIT */
window.onload = () => {
  const k = localStorage.getItem(API_KEY_STORE);
  if (k) apiKeyInput().value = k;
  const s = localStorage.getItem(SIM_KEY);
  if (s) { sims = JSON.parse(s); renderSims(); startOtp(); }
};
</script>
</body>
</html>

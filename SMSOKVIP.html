<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ThuÃª SMS OKVIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 820px;
  margin: auto;
  position: relative;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button { cursor: pointer; }
.sim {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
.sim b { font-size: 16px; }
pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow: auto;
}
.lock {
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.proxy-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: auto;
  padding: 8px 14px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
}
.sv2-btn {
  position: absolute;
  top: 15px;
  right: 120px;
  width: auto;
  padding: 8px 14px;
  background: #28a745;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.copy-btn {
  width: auto;
  padding: 4px 8px;
  margin-left: 6px;
  font-size: 12px;
}
audio {
  width: 100%;
  margin-top: 6px;
}
.done {
  color: green;
  font-weight: bold;
}
</style>
</head>

<body>
<div class="box">

<button class="sv2-btn" onclick="window.location.href='Sv2.html'">âš¡ SV2</button>
<button class="proxy-btn" onclick="window.location.href='index.html'">ğŸŒ PROXY</button>

<h2>ğŸ“² ThuÃª SMS OKVIP</h2>

<input id="apiKey" placeholder="Nháº­p API key">
<button onclick="loadAccount()">ğŸ”‘ Láº¥y thÃ´ng tin tÃ i khoáº£n</button>

<div class="lock">
  ğŸ”’ <b>ThuÃª sms:</b> Okvip â€“ <b>5K</b>
</div>

<select id="network">
  <option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>
</select>

<input id="prefix" placeholder="Äáº§u sá»‘ (vd: 098 - khÃ´ng báº¯t buá»™c)">
<button onclick="getSim()">ğŸ“ Láº¥y sá»‘</button>

<h3>ğŸ“‹ Danh sÃ¡ch SIM (tá»‘i Ä‘a 2 sim chá»)</h3>
<div id="simList"></div>

<pre id="log">Sáºµn sÃ ng</pre>
</div>

<script>
/* ================= CHá»NG INSPECT (KHÃ”NG CHáº¶N CTRL+A) ================= */
document.addEventListener("contextmenu", e => e.preventDefault());

document.addEventListener("keydown", e => {
  if (e.key === "F12") e.preventDefault();
  if (e.ctrlKey && e.key.toLowerCase() === "u") e.preventDefault();
  if (e.ctrlKey && e.shiftKey && ["i","j","c"].includes(e.key.toLowerCase())) e.preventDefault();
  if (e.ctrlKey && ["s","p"].includes(e.key.toLowerCase())) e.preventDefault();
  if (e.ctrlKey && e.key.toLowerCase() === "a") return;
});

/* ================= CONFIG ================= */
const WORKER = "https://api.dblgamingg.workers.dev";
const FIXED_SERVICE_ID = 49;

/* ================= STORAGE ================= */
const SIM_KEY = "okvip_sims";
const API_KEY_STORE = "okvip_api_key";

let sims = [];
let otpTimer = null;

/* ================= UTILS ================= */
const log = (t) => document.getElementById("log").textContent = t;
const apiKeyInput = () => document.getElementById("apiKey");
const getApiKey = () => apiKeyInput().value.trim();

async function call(path) {
  const res = await fetch(WORKER + path);
  return res.json();
}

function copyText(btn, text, isPhone = false) {
  let v = text;
  if (isPhone && v.startsWith("0")) v = v.slice(1);
  navigator.clipboard.writeText(v).then(() => {
    const old = btn.textContent;
    btn.textContent = "âœ…";
    setTimeout(() => btn.textContent = old, 1200);
  });
}

/* ================= STORAGE ================= */
function saveSims() {
  localStorage.setItem(SIM_KEY, JSON.stringify(sims));
}
function loadSims() {
  const raw = localStorage.getItem(SIM_KEY);
  if (!raw) return;
  sims = JSON.parse(raw);
  if (sims.length) {
    renderSims();
    startOtp();
  }
}

/* ================= ACCOUNT ================= */
async function loadAccount() {
  if (!getApiKey()) return alert("Nháº­p API key");
  localStorage.setItem(API_KEY_STORE, getApiKey());

  const d = await call(`/account?api_key=${getApiKey()}`);
  if (d?.data?.balance) d.data.balance /= 0.4;
  log(JSON.stringify(d, null, 2));
  loadNetworks();
}

/* ================= NETWORK ================= */
async function loadNetworks() {
  const d = await call(`/networks?api_key=${getApiKey()}`);
  const n = document.getElementById("network");
  n.innerHTML = '<option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>';
  d?.data?.forEach(x => {
    n.innerHTML += `<option value="${x.id}">${x.name}</option>`;
  });
}

/* ================= GET SIM ================= */
async function getSim() {
  if (!getApiKey()) return alert("Thiáº¿u API key");

  const network = document.getElementById("network").value;
  const prefix = document.getElementById("prefix").value;

  let q = `/get-sim?api_key=${getApiKey()}&service_id=${FIXED_SERVICE_ID}`;
  if (network) q += `&network_id=${network}`;
  if (prefix) q += `&phone=${prefix}`;

  const d = await call(q);
  if (d?.status !== 200) return log("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c sá»‘");

  sims.push({
    otpId: d.data.otpId,
    simId: d.data.simId,
    phone: d.data.phone,
    code: null,
    audio: null,
    done: false
  });

  saveSims();
  renderSims();
  startOtp();
}

/* ================= RENDER ================= */
function renderSims() {
  const box = document.getElementById("simList");
  box.innerHTML = "";

  sims.forEach((s, i) => {
    box.innerHTML += `
      <div class="sim">
        <b>ğŸ“ ${s.phone}</b>
        <button class="copy-btn" onclick="copyText(this,'${s.phone}',true)">ğŸ“‹</button><br>

        ğŸ†” OTP ID: ${s.otpId}<br>

        ğŸ” OTP:
        ${s.code ? `<span class="done">${s.code}</span>` : "Äang chá»..."}
        ${s.code ? `<button class="copy-btn" onclick="copyText(this,'${s.code}')">ğŸ“‹</button>` : ""}

        ${s.audio ? `
        <div>
          ğŸ§ OTP Gá»ŒI:
          <audio controls preload="none">
            <source src="${s.audio}" type="audio/mpeg">
          </audio>
        </div>` : ""}

        <button onclick="cancelSim(${i})">âŒ Há»§y SIM</button>
      </div>
    `;
  });
}

/* ================= OTP POLLING ================= */
function startOtp() {
  if (otpTimer) return;

  otpTimer = setInterval(async () => {
    let changed = false;

    for (const s of sims) {
      if (s.done) continue;

      const d = await call(`/get-otp?api_key=${getApiKey()}&otp_id=${s.otpId}`);
      if (!d?.data) continue;

      const content = d.data.content || "";
      const audio = d.data.audio || "";

      const match = content.match(/\b\d{4,8}\b/);
      if (match) {
        s.code = match[0];
        s.done = true;
        changed = true;
        continue;
      }

      if (audio) {
        s.audio = audio;
        s.done = true;
        changed = true;
      }
    }

    if (changed) {
      saveSims();
      renderSims();
    }

  }, 4000);
}

/* ================= CANCEL ================= */
async function cancelSim(index) {
  const s = sims[index];
  await call(`/cancel?api_key=${getApiKey()}&sim_id=${s.simId}`);

  sims.splice(index, 1);
  saveSims();
  renderSims();

  if (!sims.length) {
    clearInterval(otpTimer);
    otpTimer = null;
    localStorage.removeItem(SIM_KEY);
  }
}

/* ================= INIT ================= */
window.onload = () => {
  const savedKey = localStorage.getItem(API_KEY_STORE);
  if (savedKey) apiKeyInput().value = savedKey;
  loadSims();
};
</script>

</body>
</html>

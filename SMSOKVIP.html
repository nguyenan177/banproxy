<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>thuÃª SMS OKVIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 820px;
  margin: auto;
  position: relative;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button { cursor: pointer; }
.sim {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
}
.sim b { font-size: 16px; }
.copy-btn {
  width: auto;
  padding: 4px 10px;
  margin-left: 6px;
  font-size: 12px;
}
pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow: auto;
}
.lock {
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.proxy-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: auto;
  padding: 8px 14px;
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
}
</style>
</head>

<body>
<div class="box">

<button class="proxy-btn" onclick="window.location.href='index.html'">ğŸŒ PROXY</button>

<h2>ğŸ“² ThuÃª SMS OKVIP</h2>

<input id="apiKey" placeholder="Nháº­p API key">
<button onclick="loadAccount()">ğŸ”‘ Láº¥y thÃ´ng tin tÃ i khoáº£n</button>

<div class="lock">
  ğŸ”’ <b>ThuÃª sms:</b> Okvip â€“ <b>5K</b>
</div>

<select id="network">
  <option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>
</select>

<input id="prefix" placeholder="Äáº§u sá»‘ (vd: 098 - khÃ´ng báº¯t buá»™c)">
<button onclick="getSim()">ğŸ“ Láº¥y sá»‘</button>

<h3>ğŸ“‹ Danh sÃ¡ch SIM (tá»‘i Ä‘a 2 sim chá»)</h3>
<div id="simList"></div>

<pre id="log">Sáºµn sÃ ng</pre>
</div>

<script>
const WORKER = "https://api.dblgamingg.workers.dev";
const FIXED_SERVICE_ID = 49;

const SIM_KEY = "okvip_sims";
const API_KEY_STORE = "okvip_api_key";

let sims = [];
let otpTimer = null;

/* ===== AUDIO ===== */
let audioCtx = null;
function unlockAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume();
}
function playBeep(freq = 1200, gainValue = 0.05, duration = 0.08) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = freq;
  gain.gain.value = gainValue;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

/* ===== loading anim ===== */
let loadingDot = 0;
setInterval(() => {
  loadingDot = (loadingDot + 1) % 4;
  renderSims();
}, 500);

/* ===== copy state ===== */
let copiedState = {};

/* ===== utils ===== */
const log = t => document.getElementById("log").textContent = t;
const apiKeyInput = () => document.getElementById("apiKey");
const getApiKey = () => apiKeyInput().value.trim();
const saveApiKey = () => localStorage.setItem(API_KEY_STORE, getApiKey());
const stripZero = p => p.startsWith("0") ? p.slice(1) : p;

/* ===== copy ===== */
function copyText(key, text) {
  unlockAudio();
  navigator.clipboard.writeText(text);
  playBeep();
  copiedState[key] = true;
  setTimeout(() => {
    delete copiedState[key];
    renderSims();
  }, 1500);
  renderSims();
}

async function call(path) {
  const r = await fetch(WORKER + path);
  return r.json();
}

/* ===== account ===== */
async function loadAccount() {
  unlockAudio();
  playBeep(900, 0.04, 0.05);

  if (!getApiKey()) return alert("Nháº­p API key");
  saveApiKey();

  const d = await call(`/account?api_key=${getApiKey()}`);
  if (!d || d.status !== 200) return log("âŒ Lá»—i API");

  if (d.data?.balance) d.data.balance /= 0.4;
  log(JSON.stringify(d, null, 2));
  loadNetworks();
}

/* ===== networks ===== */
async function loadNetworks() {
  const d = await call(`/networks?api_key=${getApiKey()}`);
  if (!d || d.status !== 200) return;

  network.innerHTML = '<option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>';
  d.data.forEach(x => {
    network.innerHTML += `<option value="${x.id}">${x.name}</option>`;
  });
}

/* ===== get sim ===== */
async function getSim() {
  unlockAudio();

  if (!getApiKey()) return alert("Thiáº¿u API key");
  saveApiKey();

  let q = `/get-sim?api_key=${getApiKey()}&service_id=${FIXED_SERVICE_ID}`;
  if (network.value) q += `&network_id=${network.value}`;
  if (prefix.value) q += `&phone=${prefix.value}`;

  const d = await call(q);
  if (!d || d.status !== 200) return log("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c sá»‘");

  sims.push({
    otpId: d.data.otpId,
    simId: d.data.simId,
    phone: d.data.phone,
    code: null
  });

  saveSims();
  renderSims();
  startOtp();
}

/* ===== storage ===== */
const saveSims = () => localStorage.setItem(SIM_KEY, JSON.stringify(sims));
const loadSims = () => {
  const r = localStorage.getItem(SIM_KEY);
  if (!r) return;
  sims = JSON.parse(r);
  renderSims();
  startOtp();
};

/* ===== render ===== */
function renderSims() {
  const box = document.getElementById("simList");
  if (!box) return;
  box.innerHTML = "";

  const dots = ".".repeat(loadingDot || 1);

  sims.forEach((s, i) => {
    const phoneKey = "p" + s.phone;
    const otpKey = "o" + s.otpId;

    box.innerHTML += `
    <div class="sim">
      <b>ğŸ“ ${s.phone}</b>
      <button class="copy-btn"
        onclick="copyText('${phoneKey}','${stripZero(s.phone)}')">
        ${copiedState[phoneKey] ? "âœ…" : "ğŸ“‹"}
      </button><br>

      ğŸ†” OTP ID: ${s.otpId}<br>

      ğŸ” OTP: ${
        s.code
        ? `${s.code}
          <button class="copy-btn"
            onclick="copyText('${otpKey}','${s.code}')">
            ${copiedState[otpKey] ? "âœ…" : "ğŸ“‹"}
          </button>`
        : `Äang chá»${dots}`
      }<br>

      <button onclick="cancelSim(${i})">âŒ Há»§y SIM</button>
    </div>`;
  });
}

/* ===== otp poll (OTP Vá»€ KÃŠU TO) ===== */
function startOtp() {
  if (otpTimer) return;

  otpTimer = setInterval(async () => {
    for (const s of sims) {
      if (s.code) continue;

      const d = await call(`/get-otp?api_key=${getApiKey()}&otp_id=${s.otpId}`);
      if (d?.data?.code) {
        s.code = d.data.code;
        saveSims();

        // ğŸ”Š OTP Vá»€ â†’ Ã‚M THANH TO + DÃ€I
        unlockAudio();
        playBeep(1500, 0.15, 0.35);
      }
    }
  }, 4000);
}

/* ===== cancel ===== */
async function cancelSim(i) {
  await call(`/cancel?api_key=${getApiKey()}&sim_id=${sims[i].simId}`);
  sims.splice(i, 1);
  saveSims();
  renderSims();
  if (!sims.length) clearInterval(otpTimer);
}

/* ===== init ===== */
window.onload = () => {
  const k = localStorage.getItem(API_KEY_STORE);
  if (k) apiKeyInput().value = k;
  loadSims();
};
</script>
</body>
</html>

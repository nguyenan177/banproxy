<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Xoay IP Proxy Nhi·ªÅu API</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --bg: #f7f8fa;
    --card: #ffffff;
    --primary: #1f2937;
    --accent: #2563eb;
    --success: #16a34a;
    --danger: #dc2626;
    --border: #e5e7eb;
    --text: #111827;
    --muted: #6b7280;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    padding: 16px;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
}
.sms-okvip-btn {
    position: fixed;
    top: 16px;
    right: 16px;
    background: #f59e0b;
    color: #fff;
    padding: 10px 14px;
    font-size: 13px;
    border-radius: 999px;
    text-decoration: none;
    font-weight: 600;
    box-shadow: 0 6px 18px rgba(0,0,0,.15);
    z-index: 999;
}
h2 { text-align:center; margin-bottom:18px; }

.box {
    background:#fff;
    padding:14px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:16px;
}

textarea {
    width:100%;
    padding:12px;
    border-radius:8px;
    border:1px solid var(--border);
    resize:vertical;
    min-height:90px;
}

button {
    padding:10px 14px;
    font-size:13px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    color:#fff;
}
.btn-add{background:var(--primary);}
.btn-rotate{background:var(--accent);}
.btn-copy{background:var(--success);}
.btn-delete{background:var(--danger);}

#proxyList{
    display:flex;
    flex-direction:column;
    gap:12px;
}

.proxy-container{
    background:#fff;
    padding:12px;
    border-radius:10px;
    border:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:10px;
}

.proxy-text{
    font-family:monospace;
    font-size:13px;
    background:#f9fafb;
    border:1px dashed var(--border);
    padding:10px;
    border-radius:6px;
    word-break:break-all;
}

.proxy-actions{ display:flex; gap:8px; }

.status{
    font-size:12px;
    color:var(--muted);
}

.status.sync{
    color:var(--success);
}

@media (min-width:768px){
    body{ max-width:900px; margin:auto;}
    .proxy-container{ flex-direction:row; align-items:center;}
    .proxy-text{ flex:1;}
    .status{ min-width:180px; text-align:right;}
}
</style>
</head>
<body>

<h2>üîÑ Xoay IP Proxy Nhi·ªÅu API</h2>

<div class="box">
<textarea id="apiInput" placeholder="Nh·∫≠p API Key (m·ªói d√≤ng 1 key)"></textarea>
<br><br>
<button class="btn-add" id="addApiBtn">‚ûï Th√™m API</button>
<button class="btn-rotate" id="rotateAllBtn">üîÑ Xoay t·∫•t c·∫£</button>
<button class="btn-copy" id="copyAllBtn">üìã Copy t·∫•t c·∫£</button>
<div id="apiStatus"></div>
</div>

<div id="proxyList"></div>

<script>
let API_MAP = {};
let BOX_MAP = {};

const API_MAP_URL = "https://raw.githubusercontent.com/nguyenan177/apiv2/refs/heads/main/api_map.json";

const apiInput = document.getElementById("apiInput");
const addApiBtn = document.getElementById("addApiBtn");
const rotateAllBtn = document.getElementById("rotateAllBtn");
const copyAllBtn = document.getElementById("copyAllBtn");
const apiStatus = document.getElementById("apiStatus");
const proxyList = document.getElementById("proxyList");

let savedApis = JSON.parse(localStorage.getItem("proxy_api_keys") || "[]");

async function loadApiMap(){
    const res = await fetch(API_MAP_URL,{cache:"no-store"});
    API_MAP = await res.json();
}

function createProxyBox(apiKey){
    const info = API_MAP[apiKey];
    if(!info) return;

    const box = document.createElement("div");
    box.className="proxy-container";
    box.dataset.key = apiKey;

    const proxyText=document.createElement("div");
    proxyText.className="proxy-text";
    proxyText.innerText=info.proxy;

    const copyBtn=document.createElement("button");
    copyBtn.className="btn-copy";
    copyBtn.innerText="üìã Copy";
    copyBtn.onclick=async()=>{
        await navigator.clipboard.writeText(proxyText.innerText);
        copyBtn.innerText="‚úÖ";
        setTimeout(()=>copyBtn.innerText="üìã Copy",800);
    };

    const rotateBtn=document.createElement("button");
    rotateBtn.className="btn-rotate";
    rotateBtn.innerText="üîÑ Xoay";

    const status=document.createElement("span");
    status.className="status";

    rotateBtn.onclick=async()=>{
        rotateBtn.disabled=true;
        status.innerText="‚è≥ ƒêang xoay...";
        try{
            let url=info.rotate;
            if(url.includes("reset?proxy=")) url+=encodeURIComponent(info.proxy);
            else url+=apiKey;

            const res=await fetch(url);
            const data=await res.json();

            if(data.data?.proxy){
                info.proxy=data.data.proxy;
                proxyText.innerText=data.data.proxy;
                status.innerText="‚úÖ Xoay th√†nh c√¥ng";
            }else{
                status.innerText="‚ö†Ô∏è Kh√¥ng xoay ƒë∆∞·ª£c";
            }
        }catch{
            status.innerText="‚ùå L·ªói xoay";
        }
        rotateBtn.disabled=false;
    };

    const delBtn=document.createElement("button");
    delBtn.className="btn-delete";
    delBtn.innerText="‚ùå";
    delBtn.onclick=()=>{
        savedApis=savedApis.filter(k=>k!==apiKey);
        localStorage.setItem("proxy_api_keys",JSON.stringify(savedApis));
        delete BOX_MAP[apiKey];
        proxyList.removeChild(box);
    };

    const actions=document.createElement("div");
    actions.className="proxy-actions";
    actions.append(copyBtn,rotateBtn,delBtn);

    box.append(proxyText,actions,status);
    proxyList.appendChild(box);

    BOX_MAP[apiKey]={box,proxyText,status};
}

addApiBtn.onclick=()=>{
    const keys=apiInput.value.trim().split(/\r?\n/).map(k=>k.trim()).filter(Boolean);
    let added=0;
    keys.forEach(k=>{
        if(API_MAP[k] && !savedApis.includes(k)){
            savedApis.push(k);
            createProxyBox(k);
            added++;
        }
    });
    localStorage.setItem("proxy_api_keys",JSON.stringify(savedApis));
    apiStatus.innerText="ƒê√£ th√™m "+added+" API";
    apiInput.value="";
};

rotateAllBtn.onclick=()=>{
    Object.values(BOX_MAP).forEach(obj=>{
        obj.box.querySelector(".btn-rotate").click();
    });
};

copyAllBtn.onclick=async()=>{
    const proxies=Object.values(BOX_MAP).map(obj=>obj.proxyText.innerText);
    if(proxies.length===0)return alert("Kh√¥ng c√≥ proxy");
    await navigator.clipboard.writeText(proxies.join("\n"));
    copyAllBtn.innerText="‚úÖ ƒê√£ copy";
    setTimeout(()=>copyAllBtn.innerText="üìã Copy t·∫•t c·∫£",1200);
};

async function autoSync(){
    try{
        const res=await fetch(API_MAP_URL,{cache:"no-store"});
        const latest=await res.json();

        savedApis.forEach(key=>{
            if(!latest[key] || !BOX_MAP[key]) return;

            if(API_MAP[key].proxy !== latest[key].proxy){
                API_MAP[key].proxy=latest[key].proxy;
                BOX_MAP[key].proxyText.innerText=latest[key].proxy;
                BOX_MAP[key].status.innerText="üîÅ ƒê·ªìng b·ªô proxy m·ªõi";
                BOX_MAP[key].status.classList.add("sync");
                setTimeout(()=>BOX_MAP[key].status.classList.remove("sync"),2000);
            }
        });

        API_MAP=latest;

    }catch(e){
        console.log("AutoSync l·ªói:",e);
    }
}

setInterval(autoSync,30000);

(async()=>{
    await loadApiMap();
    savedApis.forEach(createProxyBox);
})();
</script>

</body>
</html>

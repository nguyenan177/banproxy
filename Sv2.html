<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>thuÃª SMS OKVIP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
.box {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 820px;
  margin: auto;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}
button { cursor: pointer; }

.top-btns {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}
.top-btns button {
  width: 100%;
  font-weight: bold;
}

.sim {
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  position: relative;
}
.sim b { font-size: 16px; }

pre {
  background: #111;
  color: #0f0;
  padding: 12px;
  height: 180px;
  overflow: auto;
}
.lock {
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.done {
  color: green;
  font-weight: bold;
}

/* copy ID gÃ³c pháº£i dÆ°á»›i */
.copy-id {
  position: absolute;
  bottom: 6px;
  right: 8px;
  font-size: 13px;
  cursor: pointer;
  opacity: 0.65;
}
.copy-id:hover { opacity: 1; }
</style>
</head>

<body>
<div class="box">

<div class="top-btns">
  <button onclick="location.href='SMSOKVIP.html'">ğŸ–¥ï¸ SV SIM 1</button>
  <button onclick="location.href='index.html'">ğŸŒ PROXY</button>
</div>

<h2>ğŸ“² ThuÃª SMS OKVIP</h2>

<input id="apiKey" placeholder="Nháº­p API key">
<button onclick="loadAccount()">ğŸ”‘ Láº¥y thÃ´ng tin tÃ i khoáº£n</button>

<div class="lock">
  ğŸ”’ <b>ThuÃª sms:</b> Okvip â€“ <b>14k</b>
</div>

<select id="operator">
  <option value="">-- Táº¥t cáº£ nhÃ  máº¡ng --</option>
  <option value="viettel">Viettel</option>
  <option value="mobifone">Mobifone</option>
  <option value="vinaphone">Vinaphone</option>
  <option value="vietnamobile">Vietnamobile</option>
</select>

<button onclick="getSim()">ğŸ“ Láº¥y sá»‘</button>

<h3>ğŸ“‹ Danh sÃ¡ch SIM</h3>
<div id="simList"></div>

<pre id="log">Sáºµn sÃ ng</pre>
</div>

<script>
const WORKER = "https://apiv2.dblgamingg.workers.dev/";
const SERVICE = "other";

const SIM_KEY = "eagleotp_sim";
const API_KEY_STORE = "eagleotp_api_key";

let sims = [];
let timer = null;

const log = (t) => document.getElementById("log").textContent = t;
const apiKeyInput = () => document.getElementById("apiKey");
const getApiKey = () => apiKeyInput().value.trim();

function saveKey() {
  localStorage.setItem(API_KEY_STORE, getApiKey());
}

async function call(params) {
  saveKey();
  const url = WORKER + "?" + new URLSearchParams({
    ...params,
    apikey: getApiKey()
  });
  return fetch(url).then(r => r.json());
}

function loadLocal() {
  const k = localStorage.getItem(API_KEY_STORE);
  if (k) apiKeyInput().value = k;

  const raw = localStorage.getItem(SIM_KEY);
  if (raw) {
    sims = JSON.parse(raw);
    renderSims();
    startTimer();
  }
}

async function loadAccount() {
  if (!getApiKey()) return alert("Nháº­p API key");
  const d = await call({ action: "account" });
  if (d.ResponseCode === 0) {
    d.Result.balance = Math.floor(d.Result.balance * 1.4);
  }
  log(JSON.stringify(d, null, 2));
}

async function getSim() {
  const op = document.getElementById("operator").value;
  const q = { action: "number", service: SERVICE };
  if (op) q.operator = op;

  const d = await call(q);
  if (d.ResponseCode !== 0) return log("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c sá»‘");

  sims.push({
    id: d.Result.id,
    phone: d.Result.numberno84 || d.Result.number,
    end: new Date(d.Result.end).getTime(),
    otp: null,
    sms: null
  });

  saveSims();
  renderSims();
  startTimer();
}

function renderSims() {
  const box = document.getElementById("simList");
  box.innerHTML = "";

  sims.forEach(s => {
    box.innerHTML += `
      <div class="sim">
        <b>ğŸ“ ${s.phone}</b><br>

        ğŸ” OTP:
        ${s.otp
          ? `<span class="done">${s.otp}</span>
             <a href="javascript:void(0)" onclick="toggleSMS('${s.id}')"> ğŸ‘ Xem SMS</a>
             <div id="sms-${s.id}" style="display:none">
               "SMS": "${s.sms || ""}"
             </div>`
          : "Äang chá»..."
        }<br>

        â±ï¸ <span id="t-${s.id}"></span>

        <span class="copy-id" onclick="copyId('${s.id}', this)">
          ğŸ†” ID: <span class="icon">ğŸ“‹</span>
        </span>
      </div>
    `;
  });
}

function toggleSMS(id) {
  const el = document.getElementById("sms-" + id);
  el.style.display = el.style.display === "none" ? "block" : "none";
}

function startTimer() {
  if (timer) return;
  timer = setInterval(() => {
    const now = Date.now();
    let changed = false;

    sims = sims.filter(s => {
      const left = Math.floor((s.end - now) / 1000);
      const el = document.getElementById("t-" + s.id);
      if (el) el.textContent = left > 0 ? `${left}s` : "Háº¿t háº¡n";
      if (left <= 0) changed = true;
      return left > 0;
    });

    if (changed) {
      saveSims();
      renderSims();
    }

    if (!sims.length) {
      clearInterval(timer);
      timer = null;
      localStorage.removeItem(SIM_KEY);
    }
  }, 1000);
}

async function pollOtp() {
  for (const s of sims) {
    if (s.otp) continue;

    const d = await call({ action: "code", id: s.id });
    if (d.ResponseCode === 0 && d.Result.otp) {
      s.otp = d.Result.otp;
      s.sms = d.Result.SMS || "";
      saveSims();
      renderSims();
    }
  }
}
setInterval(pollOtp, 4000);

function saveSims() {
  localStorage.setItem(SIM_KEY, JSON.stringify(sims));
}

function copyId(id, el) {
  navigator.clipboard.writeText(id);
  el.querySelector(".icon").textContent = "âœ…";
  setTimeout(() => el.querySelector(".icon").textContent = "ğŸ“‹", 1200);
}

window.onload = loadLocal;
</script>
</body>
</html>
